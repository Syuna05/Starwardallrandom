<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>星の翼ALLランダム抽選システム</title>
  <style>
    :root {
      --item-w: 90px;
      --ギャップ: 10px;
      --btn-radius: 6px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      color: #fff;
      background: url("images/background.png") center/cover no-repeat;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: -1;
    }
    h1, p {
      text-align: center;
      margin: 0.4em 0;
    }
    .container {
      padding-inline: 4vw;
      margin-top: 1.25rem;
    }
    .item-group {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(var(--item-w),1fr));
      gap: var(--ギャップ);
      margin-bottom: 2.25rem;
    }
    .item-group .cost-label {
      grid-column: 1 / -1;
      font-size: clamp(1.1rem, 2.5vw, 1.75rem);
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.25rem;
    }
    .item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      user-select: none;
    }
    .item img {
      width: 100%;
      aspect-ratio: 9 / 7;
      object-fit: cover;
      filter: brightness(50%);
      transition: filter 0.3s;
      border-radius: 4px;
    }
    .item.selected img {
      filter: brightness(100%);
    }
    .item-name {
      font-size: clamp(0.65rem, 2.6vw, 0.875rem);
      text-align: center;
      word-break: keep-all;
    }
    .button-container {
      text-align: center;
      margin-top: 1.5rem;
    }
    button {
      border: none;
      cursor: pointer;
      border-radius: var(--btn-radius);
      font-weight: 600;
    }
    #drawButton, .cost-draw-button {
      background: #4caf50;
      color: #fff;
      font-size: clamp(1rem, 3vw, 1.25rem);
      padding: 0.8em 1.6em;
    }
    #selectAllButton, #deselectAllButton {
      font-size: clamp(0.9rem, 2.4vw, 1rem);
      padding: 0.55em 1.3em;
      margin-inline: 0.3rem;
      background: #3a3a3a;
      color: #fff;
    }
    .checkbox-container {
      text-align: center;
      margin-top: 1.25rem;
    }
    #resultContainer {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 2rem;
      padding-inline: 4vw;
    }
    .result-item {
      text-align: center;
    }
    #resultContainer img {
      width: clamp(110px, 35vw, 150px);
      aspect-ratio: 3 / 2;
      object-fit: cover;
      border-radius: 6px;
    }
    .result-name {
      margin-top: 0.4rem;
      font-size: 0.9rem;
    }
    .result-rank {
      margin-top: 0.15rem;
      font-size: 0.9rem;
      font-weight: 700;
    }
    .result-rank.F覚醒 { color: #ff6666; }
    .result-rank.M覚醒 { color: #ffae42; }
    .result-rank.S覚醒 { color: #5ec8ff; }
    .result-rank.B覚醒 { color: #c0c0c0; }
    .result-rank.D覚醒 { color: #8aff8a; }
    .count-display {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.95rem;
    }
    .count-display p {
      margin: 0;
    }
    #resetButton {
      position: fixed;
      bottom: 1.2rem; right: 1.2rem;
      background: red;
      color: #fff;
      padding: 0.45rem 0.65rem;
      font-size: 0.75rem;
      border-radius: var(--btn-radius);
      opacity: 0.8;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      :root { --item-w: 75px; }
      .container { padding-inline: 6vw; }
      #resetButton { font-size: 0.65rem; padding: 0.35rem 0.55rem; }
    }
    @media (max-width: 480px) {
      :root { --item-w: 65px; }
      h1 { font-size: 1.35rem; }
      p { font-size: 0.85rem; }
      #drawButton { width: 92%; max-width: 340px; }
      .item-name { font-size: 0.7rem; }
      .count-display { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <h1>星の翼ALLランダム抽選システム</h1>
  <p>所持キャラを選択して抽選を行ってください。※覚醒は自動で選択されます</p>
  <div class="container" id="itemContainer"></div>

  <div class="button-container">
    <button id="drawButton">選択キャラから抽選</button>
  </div>

  <div class="checkbox-container">
    <input type="checkbox" id="hideAwakeningCheckbox"> 覚醒を表示しない
  </div>

  <div class="button-container">
    <button id="selectAllButton">全選択</button>
    <button id="deselectAllButton">全解除</button>
  </div>

  <div id="resultContainer"></div>

  <div class="count-display">
    <p id="totalDrawButtonCount">ボタンを押した回数: 0</p>
  </div>

  <button id="resetButton">リセット</button>

  <script>
    window.onload = function () {
      const itemContainer = document.getElementById("itemContainer");

      const imageNames = [
        "グリフィン", "スズラン", "影", "キャヴァリー", "ラジエル",
        "エルフィン", "シュウウ", "ヒカリ", "ケルビム", "ライン", "ロタ", "イーザ",
        "18号", "アンジェリス", "フリード", "シグナス", "アリス", "カゼ", "ヴァルキア", "エヴァ",
        "轟雷", "シャープ", "スカイセーバー", "シャオリン", "稲", "ノーラ", "バーゼラルド",
        "チンニ", "ザハロワ", "ダークスター",
        "セラフィム", "ヴァーチェ", "エミカ", "スコーピオン", "パラス",
        "ヒビキ", "アイーダ", "スティレット", "デュカリオン", "ベータ",
        "カタリナ", "オーキッド", "スノーウォル", "ローランド", "ヤミン"
      ];

      const costs = ["30コス", "25コス", "20コス", "15コス"];
      const costRanges = { 30: 12, 25: 15, 20: 13, 15: 5 };
      let rearrangedImageNames = [...imageNames];

      // ここで30コスのグループを保持しておくためにwindowに保存
      createItems(rearrangedImageNames, itemContainer, costs, costRanges);
      restoreSelection();
      restoreAwakeningState();

      // 抽選ボタン回数表示
      let totalDrawButtonCount = getDrawButtonCount();
      document.getElementById("totalDrawButtonCount").textContent = `ボタンを押した回数: ${totalDrawButtonCount}`;

      document.getElementById("drawButton").addEventListener("click", () => {
        drawRandomItems(rearrangedImageNames);
        totalDrawButtonCount++;
        document.getElementById("totalDrawButtonCount").textContent = `ボタンを押した回数: ${totalDrawButtonCount}`;
        saveDrawButtonCount(totalDrawButtonCount);
      });

      document.getElementById("selectAllButton").addEventListener("click", () => {
        document.querySelectorAll(".item").forEach(el => el.classList.add("selected"));
        document.querySelectorAll(".item img").forEach(img => img.style.filter = "brightness(100%)");
        saveSelection();
      });

      document.getElementById("deselectAllButton").addEventListener("click", () => {
        document.querySelectorAll(".item").forEach(el => el.classList.remove("selected"));
        document.querySelectorAll(".item img").forEach(img => img.style.filter = "brightness(50%)");
        saveSelection();
      });

      document.getElementById("resetButton").addEventListener("click", () => {
        localStorage.clear();
        location.reload();
      });

      document.getElementById("hideAwakeningCheckbox").addEventListener("change", () => {
        saveAwakeningState();
        toggleAwakeningVisibility();
      });
    };

    // 秘密キャラの順番指定 (ロタ→ラジエル→轟雷→バーゼラルド→エミカ)
    const wibelUnlockSequence = ["ロタ", "ラジエル", "轟雷", "バーゼラルド", "エミカ"];
    let wibelUnlockProgress = 0;
    let wibelUnlocked = false;

    function createItems(imageNames, parentElement, costs, costRanges) {
      let currentIndex = 0;

      costs.forEach(cost => {
        const itemGroup = document.createElement("div");
        itemGroup.classList.add("item-group");
        const costLabel = document.createElement("div");
        costLabel.classList.add("cost-label");
        costLabel.textContent = cost;
        itemGroup.appendChild(costLabel);

        const range = costRanges[parseInt(cost)] || 0;

        for (let i = 0; i < range; i++) {
          const itemDiv = createItemElement(imageNames[currentIndex], currentIndex + 1);
          itemGroup.appendChild(itemDiv);
          currentIndex++;
        }

        if (cost === "30コス") {
          window.wibelGroup = itemGroup;  // ここで30コスグループを保存
        }

        parentElement.appendChild(itemGroup);
      });
    }

    function createItemElement(name, index) {
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("item");

      const img = document.createElement("img");
      img.src = `images/item${index}.png`;
      img.alt = name;
      img.dataset.index = index;

      itemDiv.appendChild(img);

      const nameDiv = document.createElement("div");
      nameDiv.classList.add("item-name");
      nameDiv.textContent = name;
      itemDiv.appendChild(nameDiv);

      itemDiv.addEventListener("click", () => {
        itemDiv.classList.toggle("selected");
        img.style.filter = itemDiv.classList.contains("selected") ? "brightness(100%)" : "brightness(50%)";
        saveSelection();

        if (!wibelUnlocked && name === wibelUnlockSequence[wibelUnlockProgress]) {
          wibelUnlockProgress++;
          if (wibelUnlockProgress === wibelUnlockSequence.length) {
            unlockWibelItem();
          }
        } else if (name !== wibelUnlockSequence[wibelUnlockProgress]) {
          wibelUnlockProgress = 0;
        }
      });

      return itemDiv;
    }

    function unlockWibelItem() {
      if (wibelUnlocked) return;
      const name = "ウィーベル";
      const index = 997; // 適当なID

      const wibelDiv = document.createElement("div");
      wibelDiv.classList.add("item");

      const img = document.createElement("img");
      img.src = "images/ウィーベル.png";
      img.alt = name;
      img.dataset.index = index;

      wibelDiv.appendChild(img);

      const nameDiv = document.createElement("div");
      nameDiv.classList.add("item-name");
      nameDiv.textContent = name;
      wibelDiv.appendChild(nameDiv);

      // 30コスグループに追加
      if (window.wibelGroup) {
        window.wibelGroup.appendChild(wibelDiv);
      }

      wibelUnlocked = true;
      alert("隠しキャラ「ウィーベル」が解放されました！");
    }

    // 抽選処理
    function drawRandomItems(imageNames) {
      const selectedItems = [...document.querySelectorAll(".item.selected")];
      const hideAwakening = !!document.getElementById("hideAwakeningCheckbox").checked;
      const resultContainer = document.getElementById("resultContainer");

      resultContainer.innerHTML = "";

      if (selectedItems.length === 0) {
        alert("選択されたキャラがありません。");
        return;
      }

      // 選択された画像のindexを取得
      const selectedIndices = selectedItems.map(el => {
        const img = el.querySelector("img");
        return img ? parseInt(img.dataset.index) : null;
      }).filter(v => v !== null);

      // 3つランダムに選ぶ
      const resultCount = 3;
      let randomResults = [];
      for (let i = 0; i < resultCount; i++) {
        const idx = selectedIndices[Math.floor(Math.random() * selectedIndices.length)];
        randomResults.push(idx);
      }

      randomResults.forEach(idx => {
        const wrap = document.createElement("div");
        wrap.classList.add("result-item");
        let imgSrc = "";
        let imgAlt = "";
        let nameText = "";

        if (idx === 999) { // 押井（隠しキャラ例）
          imgSrc = "images/押井.png";
          imgAlt = "押井";
          nameText = "押井";
        } else if (idx === 998) { // 高山（隠しキャラ例）
          imgSrc = "images/高山.png";
          imgAlt = "高山";
          nameText = "高山";
        } else if (idx === 997) { // ウィーベル
          imgSrc = "images/ウィーベル.png";
          imgAlt = "ウィーベル";
          nameText = "ウィーベル";
        } else {
          imgSrc = `images/item${idx}.png`;
          imgAlt = imageNames[idx - 1] || "";
          nameText = imageNames[idx - 1] || "";
        }

        wrap.innerHTML = `
          <img src="${imgSrc}" alt="${imgAlt}">
          <div class="result-name">${nameText}</div>
        `;

        if (!hideAwakening) {
          const ranks = ["S覚醒", "F覚醒", "M覚醒", "B覚醒", "D覚醒"];
          const r = ranks[Math.floor(Math.random() * ranks.length)];
          wrap.innerHTML += `<div class="result-rank ${r}">${r}</div>`;
        }

        resultContainer.appendChild(wrap);
      });
    }

    // 選択状態をlocalStorageに保存
    function saveSelection() {
      const selectedIndices = [...document.querySelectorAll(".item.selected")]
        .map(el => {
          const img = el.querySelector("img");
          return img ? img.dataset.index : null;
        }).filter(v => v !== null);
      localStorage.setItem("selectedIndices", JSON.stringify(selectedIndices));
    }

    // 選択状態の復元
    function restoreSelection() {
      const saved = localStorage.getItem("selectedIndices");
      if (!saved) return;
      const selectedIndices = JSON.parse(saved);

      document.querySelectorAll(".item").forEach(el => {
        const img = el.querySelector("img");
        if (img && selectedIndices.includes(img.dataset.index)) {
          el.classList.add("selected");
          img.style.filter = "brightness(100%)";
        } else if (img) {
          el.classList.remove("selected");
          img.style.filter = "brightness(50%)";
        }
      });
    }

    // 覚醒表示状態保存
    function saveAwakeningState() {
      const hideAwakening = !!document.getElementById("hideAwakeningCheckbox").checked;
      localStorage.setItem("hideAwakening", hideAwakening ? "1" : "0");
    }

    // 覚醒表示状態復元
    function restoreAwakeningState() {
      const saved = localStorage.getItem("hideAwakening");
      if (saved === "1") {
        document.getElementById("hideAwakeningCheckbox").checked = true;
        toggleAwakeningVisibility();
      }
    }

    // 覚醒表示切替
    function toggleAwakeningVisibility() {
      const hideAwakening = !!document.getElementById("hideAwakeningCheckbox").checked;
      document.querySelectorAll(".result-rank").forEach(el => {
        el.style.display = hideAwakening ? "none" : "block";
      });
    }

    // 抽選ボタン押した回数の保存・取得
    function getDrawButtonCount() {
      return parseInt(localStorage.getItem("drawButtonCount") || "0");
    }
    function saveDrawButtonCount(count) {
      localStorage.setItem("drawButtonCount", count.toString());
    }

  </script>
</body>
</html>
