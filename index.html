<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>星の翼ALLランダム抽選システム</title>
  <style>
    :root {
      --item-w: 90px;
      --gap: 10px;
      --btn-radius: 6px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      color: #fff;
      background: url("images/background.png") center/cover no-repeat fixed;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: -1;
    }
    h1, p { text-align: center; margin: 0.4em 0; }
    .container { padding-inline: 4vw; margin-top: 1.25rem; }
    .item-group {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(var(--item-w),1fr));
      gap: var(--gap);
      margin-bottom: 2.25rem;
    }
    .item-group .cost-label {
      grid-column: 1 / -1;
      font-size: clamp(1.1rem, 2.5vw, 1.75rem);
      font-weight: 700;
      text-align: center;
      margin-bottom: .25rem;
    }
    .item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .35rem;
      cursor: pointer;
    }
    .item img {
      width: 100%;
      aspect-ratio: 9/7;
      object-fit: cover;
      filter: brightness(50%);
      transition: filter .3s;
      border-radius: 4px;
    }
    .item.selected img { filter: brightness(100%); }
    .item-name {
      font-size: clamp(.65rem, 2.6vw, .875rem);
      text-align: center;
      word-break: keep-all;
    }
    .button-container { text-align: center; margin-top: 1.5rem; }
    button {
      border: none;
      cursor: pointer;
      border-radius: var(--btn-radius);
      font-weight: 600;
    }
    #drawButton, .cost-draw-button {
      background: #4caf50;
      color: #fff;
      font-size: clamp(1rem, 3vw, 1.25rem);
      padding: .8em 1.6em;
    }
    #selectAllButton, #deselectAllButton {
      font-size: clamp(.9rem, 2.4vw, 1rem);
      padding: .55em 1.3em;
      margin-inline: .3rem;
      background: #3a3a3a;
      color: #fff;
    }
    .checkbox-container { text-align: center; margin-top: 1.25rem; }
    #resultContainer {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 2rem;
      padding-inline: 4vw;
    }
    .result-item { text-align: center; }
    #resultContainer img {
      width: clamp(110px, 35vw, 150px);
      aspect-ratio: 3/2;
      object-fit: cover;
      border-radius: 6px;
    }
    .result-name { margin-top: .4rem; font-size: .9rem; }
    .result-rank { margin-top: .15rem; font-size: .9rem; font-weight: 700; }
    .result-rank.F覚醒 { color: #ff6666; }
    .result-rank.M覚醒 { color: #ffae42; }
    .result-rank.S覚醒 { color: #5ec8ff; }
    .result-rank.B覚醒 { color: #c0c0c0; }
    .result-rank.D覚醒 { color: #8aff8a; }
    .count-display { text-align: center; margin-top: 1.5rem; font-size: .95rem; }
    .count-display p { margin: 0; }
    #resetButton {
      position: fixed;
      bottom: 1.2rem; right: 1.2rem;
      background: red;
      color: #fff;
      padding: .45rem .65rem;
      font-size: .75rem;
      border-radius: var(--btn-radius);
      opacity: .8;
    }
    @media (max-width: 768px) {
      :root { --item-w: 75px; }
      .container { padding-inline: 6vw; }
      #resetButton { font-size: .65rem; padding: .35rem .55rem; }
    }
    @media (max-width: 480px) {
      :root { --item-w: 65px; }
      h1 { font-size: 1.35rem; }
      p { font-size: .85rem; }
      #drawButton { width: 92%; max-width: 340px; }
      .item-name { font-size: .7rem; }
      .count-display { font-size: .85rem; }
    }
  </style>
</head>
<body>
  <h1>星の翼ALLランダム抽選システム</h1>
  <p>所持キャラを選択して抽選を行ってください。※覚醒は自動で選択されます</p>
  <div class="container" id="itemContainer"></div>

  <div class="button-container">
    <button id="drawButton">選択キャラから抽選</button>
  </div>

  <div class="checkbox-container">
    <input type="checkbox" id="hideAwakeningCheckbox"> 覚醒を表示しない
  </div>

  <div class="button-container">
    <button id="selectAllButton">全選択</button>
    <button id="deselectAllButton">全解除</button>
  </div>

  <div id="resultContainer"></div>

  <div class="count-display">
    <p id="totalDrawButtonCount">ボタンを押した回数: 0</p>
  </div>

  <button id="resetButton">リセット</button>

  <script>
    window.onload = function () {
      const itemContainer = document.getElementById("itemContainer");
      const imageNames = [
        "グリフィン", "スズラン", "影", "キャヴァリー", "ラジエル",
        "エルフィン", "シュウウ", "ヒカリ", "ケルビム", "ライン", "ロタ", "イーザ",
        "18号", "アンジェリス", "フリード", "シグナス", "アリス", "カゼ", "ヴァルキア", "エヴァ",
        "轟雷", "シャープ", "スカイセーバー", "シャオリン", "稲", "ノーラ", "バーゼラルド",
        "チンニ", "ザハロワ", "ダークスター",
        "セラフィム", "ヴァーチェ", "エミカ", "スコーピオン", "パラス",
        "ヒビキ", "アイーダ", "スティレット", "デュカリオン", "ベータ",
        "カタリナ", "オーキッド", "スノーウォル", "ローランド", "ヤミン"
      ];

      const costs = ["30コス", "25コス", "20コス", "15コス"];
      const costRanges = { 30: 12, 25: 15, 20: 13, 15: 5 };
      let rearrangedImageNames = [...imageNames];

      // 追加: 押井差し替え済みかチェック
      const isOshiiReplaced = JSON.parse(localStorage.getItem("oshiiReplaced")) || false;
      if (isOshiiReplaced) {
        // 全キャラ名を押井に置換
        for (let i = 0; i < rearrangedImageNames.length; i++) {
          rearrangedImageNames[i] = "押井";
        }
      }

      createItems(rearrangedImageNames, itemContainer, costs, costRanges);
      restoreSelection();
      restoreAwakeningState();

      let totalDrawButtonCount = getDrawButtonCount();
      document.getElementById("totalDrawButtonCount").textContent = `ボタンを押した回数: ${totalDrawButtonCount}`;

      document.getElementById("drawButton").addEventListener("click", () => {
        drawRandomItems(rearrangedImageNames);
        totalDrawButtonCount++;
        document.getElementById("totalDrawButtonCount").textContent = `ボタンを押した回数: ${totalDrawButtonCount}`;
        saveDrawButtonCount(totalDrawButtonCount);
      });

      document.getElementById("selectAllButton").addEventListener("click", () => {
        document.querySelectorAll(".item").forEach(el => el.classList.add("selected"));
        document.querySelectorAll(".item img").forEach(img => img.style.filter = "brightness(100%)");
        saveSelection();
      });

      document.getElementById("deselectAllButton").addEventListener("click", () => {
        document.querySelectorAll(".item").forEach(el => el.classList.remove("selected"));
        document.querySelectorAll(".item img").forEach(img => img.style.filter = "brightness(50%)");
        saveSelection();
      });

      document.getElementById("resetButton").addEventListener("click", () => {
        localStorage.clear();
        location.reload();
      });

      document.getElementById("hideAwakeningCheckbox").addEventListener("change", () => {
        saveAwakeningState();
        toggleAwakeningVisibility();
      });

      // 追加: 押井クリックカウント変数
      window.oshiiClickCount = parseInt(localStorage.getItem("oshiiClickCount")) || 0;

      // 追加: 押井解放済みフラグ
      window.secretUnlocked = JSON.parse(localStorage.getItem("secretUnlocked")) || false;

      // 追加: 押井アイテムクリックイベントに連動処理付加はcreateItemElementでやるため後で付ける
    };

    let secretUnlockSequence = ["ローランド", "スカイセーバー", "シグナス"];
    let highUnlockSequence = ["シュウウ", "デュカリオン", "バーゼラルド", "シャープ"];
    let secretUnlockProgress = 0;
    let highUnlockProgress = 0;
    let secretUnlocked = false;

    // ここで押井クリックカウントをグローバルで初期化（window.oshiiClickCountで参照）
    window.oshiiClickCount = window.oshiiClickCount || 0;

    function createItemElement(name, index) {
      const div = document.createElement("div");
      div.classList.add("item");
      div.dataset.name = name;
      div.dataset.index = index;

      const img = document.createElement("img");
      img.src = `images/${name}.png`;
      img.alt = name;
      div.appendChild(img);

      const nameDiv = document.createElement("div");
      nameDiv.classList.add("item-name");
      nameDiv.textContent = name;
      div.appendChild(nameDiv);

      // クリックイベント: 選択切替
      div.addEventListener("click", () => {
        div.classList.toggle("selected");
        // 画像明るさ変更
        if (div.classList.contains("selected")) {
          img.style.filter = "brightness(100%)";
        } else {
          img.style.filter = "brightness(50%)";
        }
        saveSelection();

        // 押井解除の条件チェック（秘密解除）
        checkSecretUnlock(name);

        // 高山追加表示条件チェック
        checkHighUnlock(name);

        // 押井クリックカウント処理
        if (name === "押井" && secretUnlocked) {
          window.oshiiClickCount++;
          localStorage.setItem("oshiiClickCount", window.oshiiClickCount);
          if (window.oshiiClickCount >= 10) {
            replaceAllWithOshii();
            window.oshiiClickCount = 0;
            localStorage.setItem("oshiiClickCount", 0);
          }
        }
      });

      return div;
    }

    function createItems(names, container, costs, costRanges) {
      container.innerHTML = "";
      let startIndex = 0;

      costs.forEach(costLabel => {
        const costDiv = document.createElement("div");
        costDiv.classList.add("cost-label");
        costDiv.textContent = costLabel;
        container.appendChild(costDiv);

        let count = costRanges[parseInt(costLabel)];
        for (let i = 0; i < count; i++) {
          if (startIndex >= names.length) break;
          const name = names[startIndex];
          const itemDiv = createItemElement(name, startIndex);
          container.appendChild(itemDiv);
          startIndex++;
        }
      });

      // 秘密キャラ「押井」が解放済なら最後に追加表示
      if (secretUnlocked) {
        const oshiiDiv = createItemElement("押井", 999);
        oshiiDiv.querySelector("img").src = "images/押井.png";
        oshiiDiv.classList.add("secret");
        container.appendChild(oshiiDiv);
      }
    }

    // 秘密キャラ「押井」解除チェック関数
    function checkSecretUnlock(name) {
      if (secretUnlocked) return;
      if (name === secretUnlockSequence[secretUnlockProgress]) {
        secretUnlockProgress++;
        if (secretUnlockProgress >= secretUnlockSequence.length) {
          unlockSecretItem();
        }
      } else {
        secretUnlockProgress = 0;
      }
    }

    function unlockSecretItem() {
      secretUnlocked = true;
      localStorage.setItem("secretUnlocked", true);
      alert("秘密キャラ「押井」が解放されました！");
      // 押井アイテムを追加表示
      const container = document.getElementById("itemContainer");
      const oshiiDiv = createItemElement("押井", 999);
      oshiiDiv.querySelector("img").src = "images/押井.png";
      oshiiDiv.classList.add("secret");
      container.appendChild(oshiiDiv);
    }

    // 高山追加表示処理（例）
    function checkHighUnlock(name) {
      // 実装例（省略）
    }

    // 抽選処理（選択キャラからランダムに抽選）
    function drawRandomItems(names) {
      const selectedItems = [...document.querySelectorAll(".item.selected")];
      if (selectedItems.length === 0) {
        alert("キャラを1体以上選択してください。");
        return;
      }

      // 抽選数は固定3体など（例）
      const drawCount = 3;
      const resultsContainer = document.getElementById("resultContainer");
      resultsContainer.innerHTML = "";

      // ランダム抽選
      for (let i = 0; i < drawCount; i++) {
        const randIndex = Math.floor(Math.random() * selectedItems.length);
        const selected = selectedItems[randIndex];
        const clone = selected.cloneNode(true);
        clone.classList.remove("selected");
        // 覚醒表示用
        const rankDiv = document.createElement("div");
        rankDiv.classList.add("result-rank");
        // ここは簡単に仮実装。必要に応じて置き換え
        rankDiv.textContent = "覚醒";
        clone.appendChild(rankDiv);
        resultsContainer.appendChild(clone);
      }
    }

    // 選択状態保存
    function saveSelection() {
      const selectedNames = [...document.querySelectorAll(".item.selected")].map(el => el.dataset.name);
      localStorage.setItem("selectedNames", JSON.stringify(selectedNames));
    }

    // 選択状態復元
    function restoreSelection() {
      const selectedNames = JSON.parse(localStorage.getItem("selectedNames") || "[]");
      document.querySelectorAll(".item").forEach(item => {
        if (selectedNames.includes(item.dataset.name)) {
          item.classList.add("selected");
          item.querySelector("img").style.filter = "brightness(100%)";
        }
      });
    }

    // 覚醒表示保存・復元（省略）
    function saveAwakeningState() {
      const checked = document.getElementById("hideAwakeningCheckbox").checked;
      localStorage.setItem("hideAwakening", checked);
    }
    function restoreAwakeningState() {
      const hideAwakening = JSON.parse(localStorage.getItem("hideAwakening")) || false;
      document.getElementById("hideAwakeningCheckbox").checked = hideAwakening;
      toggleAwakeningVisibility();
    }
    function toggleAwakeningVisibility() {
      const hide = document.getElementById("hideAwakeningCheckbox").checked;
      document.querySelectorAll(".result-rank").forEach(el => {
        el.style.display = hide ? "none" : "block";
      });
    }

    // ボタン押下回数保存・取得
    function saveDrawButtonCount(count) {
      localStorage.setItem("drawButtonCount", count);
    }
    function getDrawButtonCount() {
      return parseInt(localStorage.getItem("drawButtonCount")) || 0;
    }

    // 追加: すべてを押井に置き換える関数
    function replaceAllWithOshii() {
      // 全アイテムを押井に差し替え
      document.querySelectorAll(".item").forEach(item => {
        const img = item.querySelector("img");
        const nameDiv = item.querySelector(".item-name");
        img.src = "images/押井.png";
        img.alt = "押井";
        nameDiv.textContent = "押井";
      });

      // 抽選結果も押井に差し替え
      document.querySelectorAll("#resultContainer .item").forEach(item => {
        const img = item.querySelector("img");
        const nameDiv = item.querySelector(".item-name");
        if (img && nameDiv) {
          img.src = "images/押井.png";
          img.alt = "押井";
          nameDiv.textContent = "押井";
        }
      });

      alert("すべてのキャラが「押井」に置き換わりました！");
      localStorage.setItem("oshiiReplaced", true);
    }

  </script>
</body>
</html>
